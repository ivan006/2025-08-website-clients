<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Filter Combination Visualizer (Nested Groups + Time Cap)</title>
<style>
  body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;padding:24px;background:#fafafa;line-height:1.45}
  h1{font-size:1.2rem;margin:0 0 12px}
  .row{margin:8px 0}
  input,select,button{font-size:1rem;padding:.4rem .6rem}
  button{cursor:pointer}
  #result{margin-top:12px;font-weight:700}
  ul{list-style:none;padding-left:1.1rem;margin:.25rem 0}
  li{margin:.15rem 0}
  .group{font-weight:600;margin-top:.4rem}
  code{background:#eee;padding:.1rem .3rem;border-radius:4px}
  .muted{color:#666}
</style>
</head>
<body>
  <h1>Filter Combination Visualizer</h1>

  <div class="row">
    <label>Enter filter option counts (comma-separated, left = highest priority):</label><br>
    <input id="numbers" type="text" size="40" placeholder="e.g. 2,3,4,5">
  </div>

  <div class="row">
    <label>Mode:</label><br>
    <select id="mode">
      <option value="overthetop" selected>Over-the-top (all filters)</option>
      <option value="reinedin">Reined-in (top-2 filters)</option>
    </select>
  </div>

  <div class="row">
    <label><input id="includeAll" type="checkbox" checked>
      Include “All” option for each filter</label>
  </div>

  <div class="row"><button onclick="calculate()">Calculate</button></div>

  <div id="result"></div>
  <div id="details" class="muted"></div>

<script>
function parseCounts(raw){
  return raw.split(',').map(s=>s.trim()).filter(Boolean)
            .map(Number).filter(n=>Number.isFinite(n)&&n>=0);
}
function prod(a){return a.reduce((p,v)=>p*v,1);}

function calculate(){
  const raw=document.getElementById('numbers').value.trim();
  const mode=document.getElementById('mode').value;
  const includeAll=document.getElementById('includeAll').checked;
  const counts=parseCounts(raw);
  if(!counts.length){
    document.getElementById('result').textContent='Enter some numbers.';
    document.getElementById('details').innerHTML='';
    return;
  }

  let combos=0,detailsHTML='';
  if(mode==='overthetop'){
    const adjusted=counts.map(n=>includeAll?n+1:n);
    combos=prod(adjusted);
    if(includeAll) combos-=1;
    detailsHTML=renderNested(counts,includeAll);  // NEW nested tree
  }else{
    const top2=counts.slice(0,2);
    if(top2.length===1){
      combos=includeAll?top2[0]+1:top2[0];
      detailsHTML=renderOne(top2[0],includeAll);
    }else{
      const [n1,n2]=top2;
      combos=(includeAll?n1+1:n1)*(includeAll?n2+1:n2);
      detailsHTML=renderTwo(n1,n2,includeAll);
    }
  }

  document.getElementById('result').textContent=`Combinations: ${combos.toLocaleString()}`;
  document.getElementById('details').innerHTML=detailsHTML;
}

/* ----------  OVER-THE-TOP: nested groups with 5 s cap ---------- */
function renderNested(counts,includeAll){
  const start=performance.now();
  const optsArr=counts.map((n,idx)=>Array.from({length:includeAll?n+1:n},(_,i)=>i));
  const label=(i,n)=>includeAll&&i===n?'All':`Option ${i+1}`;
  let html='<ul>'; let done=0,cut=false;

  function loop(level,path){
    if(performance.now()-start>5000){cut=true;return true;} // stop after ~5 s
    if(level===optsArr.length){
      done++; html+=`<li><code>${path.join(' → ')}</code></li>`;
      return false;
    }
    const opts=optsArr[level];
    opts.forEach(i=>{
      if(performance.now()-start>5000){cut=true;return;}
      const seg=`Filter ${level+1} – ${label(i,counts[level])}`;
      html+=`<li class="group">${seg}<ul>`;
      loop(level+1,[...path,seg]);
      html+='</ul></li>';
    });
  }
  loop(0,[]);
  html+='</ul>';
  if(cut) html+=`<div style="color:#c00;margin-top:8px;">Stopped after 5 s (${done.toLocaleString()} combos rendered)</div>`;
  return html;
}

/* ----------  REINED-IN: one- and two-filter helpers ---------- */
function renderOne(n1,includeAll){
  const opts1=Array.from({length:includeAll?n1+1:n1},(_,i)=>i);
  const label1=i=>includeAll&&i===n1?'All':`Option ${i+1}`;
  let html='<ul>';
  opts1.forEach(i=>{
    html+=`<li>Filter 1 – ${label1(i)} → <code>F1_${label1(i).replace(' ','')}</code></li>`;
  });
  html+='</ul>';
  return html;
}

function renderTwo(n1,n2,includeAll){
  const opts1=Array.from({length:includeAll?n1+1:n1},(_,i)=>i);
  const opts2=Array.from({length:includeAll?n2+1:n2},(_,i)=>i);
  const label1=i=>includeAll&&i===n1?'All':`Option ${i+1}`;
  const label2=j=>includeAll&&j===n2?'All':`Option ${j+1}`;
  const start=performance.now();
  let html='<ul>'; let cut=false;
  opts1.forEach(i=>{
    if(performance.now()-start>5000){cut=true;return;}
    html+=`<li class="group">Filter 1 – ${label1(i)}<ul>`;
    opts2.forEach(j=>{
      if(performance.now()-start>5000){cut=true;return;}
      html+=`<li>Filter 2 – ${label2(j)} → <code>F1_${label1(i).replace(' ','')}-F2_${label2(j).replace(' ','')}</code></li>`;
    });
    html+='</ul></li>';
  });
  html+='</ul>';
  if(cut) html+=`<div style="color:#c00;margin-top:8px;">Stopped after 5 s</div>`;
  return html;
}
</script>
</body>
</html>
